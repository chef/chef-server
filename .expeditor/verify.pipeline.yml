---
expeditor:
  cached_folders:
    - vendor
  defaults:
    buildkite:
      timeout_in_minutes: 30

steps:

#########################################################################
  # Lint Tests
#########################################################################

# - label: license-scout
#   command:
#     - .expeditor/license_scout.sh
#   expeditor:
#     executor:
#       docker:
#         environment:
#           - OCTOKIT_ACCESS_TOKEN

#########################################################################
  # Component Tests
#########################################################################

# - label: omnibus
#   command:
#     - /workdir/scripts/bk_tests/bk_install.sh
#     - gem uninstall bundler -v '>= 2.0.1' -a
#     - cd /workdir/omnibus; make install
#     - make ci
#   expeditor:
#     executor:
#       docker:
#         image: "chefes/a1-buildkite"
#         environment:
#           - LUALIB=~/.luarocks/lib/lua/5.2
#           - COMPONENT=omnibus

# - label: chef-server-ctl
#   command:
#     - /workdir/scripts/bk_tests/bk_install.sh
#     - cd /workdir/src/chef-server-ctl; make install
#     - make ci
#   expeditor:
#     executor:
#       docker:
#         image: "chefes/a1-buildkite"
#         environment:
#           - COMPONENT=src/chef-server-ctl

# - label: oc_erchef_unit
#   command:
#     - date
#     - /workdir/scripts/bk_tests/bk_install.sh
#     - date
#     - cd /workdir/src/oc_erchef; make install
#     - make ci_eunit
#     - date
#   expeditor:
#     executor:
#       docker:
#         image: "chefes/a1-buildkite"
#         environment:
#           - PATH=/opt/asdf/shims:/opt/asdf/bin:/opt/ci-studio-common/bin:/go/bin:/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/chefdk/bin
#           - PERL5LIB=~/perl5/lib/perl5/x86_64-linux-gnu-thread-multi:~/perl5/lib/perl5:/etc/perl:/usr/local/lib/perl/5.14.2:/usr/local/share/perl/5.14.2:/usr/lib/perl5:/usr/share/perl5:/usr/lib/perl/5.14:/usr/share/perl/5.14:/usr/local/lib/site_perl
#           - LUALIB=~/.luarocks/lib/lua/5.2
#           - ELIXIR_VERSION=1.4
#           - COMPONENT=src/oc_

# - label: oc_erchef_ct
#   command:
#     - date
#     - /workdir/scripts/bk_tests/bk_install.sh
#     - date
#     - cd /workdir/src/oc_erchef; make install
#     - make ci_ct
#     - date
#   expeditor:
#     executor:
#       docker:
#         image: "chefes/a1-buildkite"
#         environment:
#           - PATH=/opt/asdf/shims:/opt/asdf/bin:/opt/ci-studio-common/bin:/go/bin:/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/chefdk/bin
#           - PERL5LIB=~/perl5/lib/perl5/x86_64-linux-gnu-thread-multi:~/perl5/lib/perl5:/etc/perl:/usr/local/lib/perl/5.14.2:/usr/local/share/perl/5.14.2:/usr/lib/perl5:/usr/share/perl5:/usr/lib/perl/5.14:/usr/share/perl/5.14:/usr/local/lib/site_perl
#           - LUALIB=~/.luarocks/lib/lua/5.2
#           - ELIXIR_VERSION=1.4
#           - COMPONENT=src/oc_erchef

# - label: oc-id
#   command:
#     - /workdir/scripts/bk_tests/bk_install.sh
#     - cd /workdir/src/oc-id
#     - make install ci
#   expeditor:
#     executor:
#       docker:
#         image: "chefes/a1-buildkite"
#         environment:
#           - COMPONENT=src/oc-id

# - label: oc_bifrost
#   command:
#     - /workdir/scripts/bk_tests/bk_install.sh
#     - cd /workdir/src/oc_bifrost; make install
#     - make ci
#   expeditor:
#     executor:
#       docker:
#         image: "chefes/a1-buildkite"
#         environment:
#           - PATH=/opt/asdf/shims:/opt/asdf/bin:/opt/ci-studio-common/bin:/go/bin:/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/chefdk/bin
#           - PERL5LIB=~/perl5/lib/perl5/x86_64-linux-gnu-thread-multi:~/perl5/lib/perl5:/etc/perl:/usr/local/lib/perl/5.14.2:/usr/local/share/perl/5.14.2:/usr/lib/perl5:/usr/share/perl5:/usr/lib/perl/5.14:/usr/share/perl/5.14:/usr/local/lib/site_perl
#           - LUALIB=~/.luarocks/lib/lua/5.2
#           - COMPONENT=src/oc_bifrost

# - label: bookshelf
#   command:
#     - /workdir/scripts/bk_tests/bk_install.sh
#     - cd /workdir/src/bookshelf; make install
#     - make ci
#   expeditor:
#     executor:
#       docker:
#         image: "chefes/a1-buildkite"
#         environment:
#           - PATH=/opt/asdf/shims:/opt/asdf/bin:/opt/ci-studio-common/bin:/go/bin:/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/chefdk/bin
#           - PERL5LIB=~/perl5/lib/perl5/x86_64-linux-gnu-thread-multi:~/perl5/lib/perl5:/etc/perl:/usr/local/lib/perl/5.14.2:/usr/local/share/perl/5.14.2:/usr/lib/perl5:/usr/share/perl5:/usr/lib/perl/5.14:/usr/share/perl/5.14:/usr/local/lib/site_perl
#           - LUALIB=~/.luarocks/lib/lua/5.2
#           - COMPONENT=src/bookshelf

# #########################################################################
#   # Habitat Packages of Infra Server
# #########################################################################

# - label: bookshelf-hab
#   command:
#       - /workdir/.expeditor/habitat.sh
#   expeditor:
#       executor:
#         docker:
#           privileged: true
#           environment:
#             - OCTOKIT_ACCESS_TOKEN
#             - HAB_LICENSE=accept
#             - CHEF_LICENSE="accept-no-persist"
#             - CI="true"
#             - HAB_ORIGIN=cheftest
#             - HAB_ORIGIN_KEYS=cheftest
#             - HAB_STUDIO_SECRET_HAB_FEAT_IGNORE_LOCAL="true"
#             - HAB_FEAT_IGNORE_LOCAL="true"
#             - PACKAGE_NAME=bookshelf

# - label: cs-nginx-hab
#   command:
#       - /workdir/.expeditor/habitat.sh
#   expeditor:
#       executor:
#         docker:
#           privileged: true
#           environment:
#             - OCTOKIT_ACCESS_TOKEN
#             - HAB_LICENSE=accept
#             - CHEF_LICENSE="accept-no-persist"
#             - CI="true"
#             - HAB_ORIGIN=chef
#             - HAB_ORIGIN_KEYS=chef
#             - HAB_STUDIO_SECRET_HAB_FEAT_IGNORE_LOCAL="true"
#             - HAB_FEAT_IGNORE_LOCAL="true"
#             - PACKAGE_NAME=nginx

# - label: chef-server-ctl-hab
#   command:
#       - /workdir/.expeditor/habitat.sh
#   expeditor:
#       executor:
#         docker:
#           privileged: true
#           environment:
#             - OCTOKIT_ACCESS_TOKEN
#             - HAB_LICENSE=accept
#             - CHEF_LICENSE="accept-no-persist"
#             - CI="true"
#             - HAB_ORIGIN=chef
#             - HAB_ORIGIN_KEYS=chef
#             - HAB_STUDIO_SECRET_HAB_FEAT_IGNORE_LOCAL="true"
#             - HAB_FEAT_IGNORE_LOCAL="true"
#             - PACKAGE_NAME=chef-server-ctl

# - label: oc_bifrost-hab
#   command:
#       - /workdir/.expeditor/habitat.sh
#   expeditor:
#       executor:
#         docker:
#           privileged: true
#           environment:
#             - OCTOKIT_ACCESS_TOKEN
#             - HAB_LICENSE=accept
#             - CHEF_LICENSE="accept-no-persist"
#             - CI="true"
#             - HAB_ORIGIN=chef
#             - HAB_ORIGIN_KEYS=chef
#             - HAB_STUDIO_SECRET_HAB_FEAT_IGNORE_LOCAL="true"
#             - HAB_FEAT_IGNORE_LOCAL="true"
#             - PACKAGE_NAME=oc_bifrost

# - label: oc_erchef-hab
#   command:
#       - /workdir/.expeditor/habitat.sh
#   expeditor:
#       executor:
#         docker:
#           privileged: true
#           environment:
#             - OCTOKIT_ACCESS_TOKEN
#             - HAB_LICENSE=accept
#             - CHEF_LICENSE="accept-no-persist"
#             - CI="true"
#             - HAB_ORIGIN=chef
#             - HAB_ORIGIN_KEYS=chef
#             - HAB_STUDIO_SECRET_HAB_FEAT_IGNORE_LOCAL="true"
#             - HAB_FEAT_IGNORE_LOCAL="true"
#             - PACKAGE_NAME=oc_erchef

# - label: openresty-noroot-hab
#   command:
#       - /workdir/.expeditor/habitat.sh
#   expeditor:
#       executor:
#         docker:
#           privileged: true
#           environment:
#             - OCTOKIT_ACCESS_TOKEN
#             - HAB_LICENSE=accept
#             - CHEF_LICENSE="accept-no-persist"
#             - CI="true"
#             - HAB_ORIGIN=chef
#             - HAB_ORIGIN_KEYS=chef
#             - HAB_STUDIO_SECRET_HAB_FEAT_IGNORE_LOCAL="true"
#             - HAB_FEAT_IGNORE_LOCAL="true"
#             - PACKAGE_NAME=openresty-noroot

# - label: oc_id-hab
#   command:
#       - /workdir/.expeditor/habitat.sh
#   expeditor:
#       executor:
#         docker:
#           privileged: true
#           environment:
#             - OCTOKIT_ACCESS_TOKEN
#             - HAB_LICENSE=accept
#             - CHEF_LICENSE="accept-no-persist"
#             - CI="true"
#             - HAB_ORIGIN=chef
#             - HAB_ORIGIN_KEYS=chef
#             - HAB_STUDIO_SECRET_HAB_FEAT_IGNORE_LOCAL="true"
#             - HAB_FEAT_IGNORE_LOCAL="true"
#             - PACKAGE_NAME=oc-id

# #########################################################################
#   # Tests for Chef-Automate
# #########################################################################

# - label: "chef server"
#   command:
#       - /workdir/integration/run_test /workdir/integration/tests/chef_server.sh
#   timeout_in_minutes: 30 # longer timeout for chef-server
#   expeditor:
#       executor:
#         linux:
#           privileged: true
#       # secrets:
#       #   A2_LICENSE:
#       #     path: secret/a2/license
#       #     field: license

# - label: "chef server only"
#   command:
#       - integration/run_test integration/tests/chef_server_only.sh
#   timeout_in_minutes: 30
#   expeditor:
#       executor:
#         linux:
#           privileged: true
#       secrets:
#         A2_LICENSE:
#           path: secret/a2/license
#           field: license     

# - label: "ha chef server"
#   command:
#       - integration/run_test integration/tests/ha_chef_server.sh
#   timeout_in_minutes: 35
#   expeditor:
#       executor:
#         linux:
#           single-use: true
#           privileged: true
#       secrets:
#         A2_LICENSE:
#           path: secret/a2/license
#           field: license


# #########################################################################
#   # Pedant Tests
# #########################################################################

# - label: With chef-zero
#   command:
#     - /workdir/scripts/bk_tests/bk_install.sh
#     - gem uninstall bundler -v '>= 2.0.1' -a
#     - cp scripts/bk_tests/chef_zero-Gemfile oc-chef-pedant/Gemfile
#     - bundle install --jobs=3 --retry=3 --path=/workdir/vendor/bundle
#     - cd /workdir/oc-chef-pedant
#     - bundle exec rake chef_zero_spec
#   expeditor:
#     executor:
#       docker:
#         image: "chefes/a1-buildkite"
#         environment:
#           - LUALIB=~/.luarocks/lib/lua/5.2
#           - USE_OMNIBUS_FILES=0
#           - PEDANT_OPTS="--skip-oc_id"
#           - BUNDLE_GEMFILE=/workdir/oc-chef-pedant/Gemfile

# - label: With ChefFS=1
#   command:
#     - /workdir/scripts/bk_tests/bk_install.sh
#     - gem install bundler -v 2.2.4
#     - gem uninstall bundler -v '> 2.2.4' -a
#     - cp scripts/bk_tests/chef_zero-Gemfile oc-chef-pedant/Gemfile
#     - bundle install --jobs=3 --retry=3 --path=/workdir/vendor/bundle
#     - cd /workdir/oc-chef-pedant
#     - bundle exec rake chef_zero_spec
#   expeditor:
#     executor:
#       docker:
#         image: "chefes/a1-buildkite"
#         environment:
#           - LUALIB=~/.luarocks/lib/lua/5.2
#           - USE_OMNIBUS_FILES=0
#           - PEDANT_OPTS="--skip-oc_id"
#           - CHEF_FS=1
          # - BUNDLE_GEMFILE=/workdir/oc-chef-pedant/Gemfile

# - wait

- label: automate_build
  command:
      - .expeditor/automate_build.sh
  env:
      ALLOW_LOCAL_PACKAGES: true
      HAB_STUDIO_SUP: false
      HAB_NONINTERACTIVE: true
      # HAB_STUDIO_SECRET_HAB_FEAT_IGNORE_LOCAL: true
      # HAB_STUDIO_SECRET_HAB_FEAT_OFFLINE_INSTALL: true
      HAB_BINLINK_DIR: /hab/bin
  expeditor:
    secrets:
        HAB_STUDIO_SECRET_GITHUB_TOKEN:
          account: github/chef
          field: token
        OPENSEARCH_ROOT_CA_PEM:
          path: secret/a2/a2ha/opensearch
          field: root-ca.pem
        OPENSEARCH_ADMIN_PEM:
          path: secret/a2/a2ha/opensearch
          field: admin.pem
        OPENSEARCH_ADMIN_KEY_PEM:
          path: secret/a2/a2ha/opensearch
          field: admin-key.pem
        OPENSEARCH_NODE1_PEM:
          path: secret/a2/a2ha/opensearch
          field: node1.pem
        OPENSEARCH_NODE1_KEY_PEM:
          path: secret/a2/a2ha/opensearch
          field: node1-key.pem
    executor:
        linux:
          privileged: true
      # executor:
      #   docker:
      #     privileged: true
      #     environment:
      #       - OCTOKIT_ACCESS_TOKEN
      #       - HAB_LICENSE=accept
      #       - CHEF_LICENSE="accept-no-persist"
      #       - CI="true"
      #       - HAB_ORIGIN=chef
      #       - HAB_ORIGIN_KEYS=chef
      #       - HAB_STUDIO_SECRET_HAB_FEAT_IGNORE_LOCAL="true"
      #       - HAB_FEAT_IGNORE_LOCAL="true"
      #       - PACKAGE_NAME=oc-id
      #       - HAB_FEAT_OFFLINE_INSTALL=true
 
