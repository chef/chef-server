---
expeditor:
  defaults:
    buildkite:
      timeout_in_minutes: 30

steps:

#########################################################################
  # Lint Tests
#########################################################################

- label: lint-terraform
  command:
    - cd /workdir/terraform
    - make lint
  expeditor:
    executor:
      docker:

- label: lint-chef-server-deploy-cookbook-cookstyle
  command:
    - cd /workdir/cookbooks/chef-server-deploy
    - chef exec cookstyle
  expeditor:
    executor:
      docker:

- label: chef-server-deploy-cookbook-foodcritic
  command:
    - cd /workdir/cookbooks/chef-server-deploy
    - chef exec foodcritic . -t ~supermarket
  expeditor:
    executor:
      docker:

- label: license-scout
  command:
    - .expeditor/license_scout.sh
  expeditor:
    executor:
      docker:
        environment:
          - EXPEDITOR=true

#########################################################################
  # Component Tests
#########################################################################

- label: omnibus
  command:
    - /workdir/scripts/bk_tests/bk_install.sh
    - cd /workdir/omnibus; make install
    - make ci
  expeditor:
    executor:
      docker:
        privileged: true
        image: "chefes/a1-buildkite"
        environment:
          - LUALIB=~/.luarocks/lib/lua/5.2
          - ELIXIR_VERSION=1.4
          - ERLANG_VERSION=18.3
          - COMPONENT=omnibus

- label: chef-server-ctl
  command:
    - /workdir/scripts/bk_tests/bk_install.sh
    - cd /workdir/src/chef-server-ctl; make install
    - make ci
  expeditor:
    executor:
      docker:
        privileged: true
        image: "chefes/a1-buildkite"
        environment:
          - COMPONENT=src/chef-server-ctl

- label: oc_erchef
  command:
    - /workdir/scripts/bk_tests/bk_install.sh
    - cd /workdir/src/oc_erchef; make install
    - make ci
  expeditor:
    executor:
      docker:
        privileged: true
        image: "chefes/a1-buildkite"
        environment:
          - USE_OMNIBUS_FILES=0
          - CHEFDK_GECODE_PATH=/opt/chefdk/embedded/lib/ruby/gems/2.4.0/gems/dep-selector-libgecode-1.3.1/lib/dep-selector-libgecode/vendored-gecode
          - PATH=~/perl5/bin:$PATH
          - LUALIB=~/.luarocks/lib/lua/5.2
          - COMPONENT=src/oc_erchef

- label: oc-id
  command:
    - apt-get update -y && apt-get install -y libsqlite3-dev
    - /workdir/scripts/bk_tests/bk_install.sh
    - cd /workdir/src/oc-id; make install
    - make ci
  expeditor:
    executor:
      docker:
        privileged: true
        image: "chefes/a1-buildkite"
        environment:
          - COMPONENT=src/oc-id

- label: chef-mover
  command:
    - /workdir/scripts/bk_tests/bk_install.sh
    - cd /workdir/src/chef-mover; make install
    - make ci
  expeditor:
    executor:
      docker:
        privileged: true
        image: "chefes/a1-buildkite"
        environment:
          - PATH=/opt/asdf/shims:/opt/asdf/bin:/opt/ci-studio-common/bin:/go/bin:/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/chefdk/bin:/opt/asdf/installs/ruby/2.5.1/bin
          - PERL5LIB=~/perl5/lib/perl5/x86_64-linux-gnu-thread-multi:~/perl5/lib/perl5:/etc/perl:/usr/local/lib/perl/5.14.2:/usr/local/share/perl/5.14.2:/usr/lib/perl5:/usr/share/perl5:/usr/lib/perl/5.14:/usr/share/perl/5.14:/usr/local/lib/site_perl
          - LUALIB=~/.luarocks/lib/lua/5.2
          - ELIXIR_VERSION=1.4
          - ERLANG_VERSION=18.3
          - COMPONENT=src/chef-mover

- label: oc_bifrost
  command:
    - /workdir/scripts/bk_tests/bk_install.sh
    - cd /workdir/src/oc_bifrost; make install
    - make ci
  expeditor:
    executor:
      docker:
        privileged: true
        image: "chefes/a1-buildkite"
        environment:
          - PATH=/opt/asdf/shims:/opt/asdf/bin:/opt/ci-studio-common/bin:/go/bin:/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/chefdk/bin:/opt/asdf/installs/ruby/2.5.1/bin
          - PERL5LIB=~/perl5/lib/perl5/x86_64-linux-gnu-thread-multi:~/perl5/lib/perl5:/etc/perl:/usr/local/lib/perl/5.14.2:/usr/local/share/perl/5.14.2:/usr/lib/perl5:/usr/share/perl5:/usr/lib/perl/5.14:/usr/share/perl/5.14:/usr/local/lib/site_perl
          - LUALIB=~/.luarocks/lib/lua/5.2
          - ELIXIR_VERSION=1.4
          - ERLANG_VERSION=18.3
          - COMPONENT=src/oc_bifrost

- label: bookshelf
  command:
    - /workdir/scripts/bk_tests/bk_install.sh
    - cd /workdir/src/bookshelf; make install
    - make ci
  expeditor:
    executor:
      docker:
        privileged: true
        image: "chefes/a1-buildkite"
        environment:
          - PATH=/opt/asdf/shims:/opt/asdf/bin:/opt/ci-studio-common/bin:/go/bin:/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/chefdk/bin:/opt/asdf/installs/ruby/2.5.1/bin
          - PERL5LIB=~/perl5/lib/perl5/x86_64-linux-gnu-thread-multi:~/perl5/lib/perl5:/etc/perl:/usr/local/lib/perl/5.14.2:/usr/local/share/perl/5.14.2:/usr/lib/perl5:/usr/share/perl5:/usr/lib/perl/5.14:/usr/share/perl/5.14:/usr/local/lib/site_perl
          - LUALIB=~/.luarocks/lib/lua/5.2
          - COMPONENT=src/bookshelf

# #########################################################################
#   # Pedant Tests
# #########################################################################

- label: With chef-zero
  command:
    - /workdir/scripts/bk_tests/bk_install.sh
    # - gem install bundler -v 1.12.5 && rm -f oc-chef-pedant/Gemfile.lock  # todo:  remove heavy dependency on bundler version 1.12.5 later
    - gem uninstall bundler -v '>= 2.0.1' -a
    - cp scripts/bk_tests/chef_zero-Gemfile oc-chef-pedant/Gemfile
    - bundle install
    - cd /workdir/oc-chef-pedant
    - bundle exec rake chef_zero_spec
  expeditor:
    executor:
      docker:
        privileged: true
        image: "chefes/a1-buildkite"
        environment:
          - LUALIB=~/.luarocks/lib/lua/5.2
          - USE_OMNIBUS_FILES=0
          - PEDANT_OPTS="--skip-oc_id"
          - BUNDLE_GEMFILE=/workdir/oc-chef-pedant/Gemfile

- label: With ChefFS=1
  command:
    - /workdir/scripts/bk_tests/bk_install.sh
    # - gem install bundler -v 1.12.5 && rm -f oc-chef-pedant/Gemfile.lock  # todo:  remove heavy dependency on bundler version 1.12.5 later
    - gem uninstall bundler -v '>= 2.0.1' -a
    - cp scripts/bk_tests/chef_zero-Gemfile oc-chef-pedant/Gemfile
    - bundle install
    - cd /workdir/oc-chef-pedant
    - bundle exec rake chef_zero_spec
  expeditor:
    executor:
      docker:
        privileged: true
        image: "chefes/a1-buildkite"
        environment:
          # - USE_OMNIBUS_FILES=0
          # - CHEFDK_GECODE_PATH=/opt/chefdk/embedded/lib/ruby/gems/2.5.0/gems/dep-selector-libgecode-1.3.1/lib/dep-selector-libgecode/vendored-gecode
          # - LIBRARY_PATH=$CHEFDK_GECODE_PATH/lib
          # - LD_LIBRARY_PATH=$CHEFDK_GECODE_PATH/lib
          # - CPLUS_INCLUDE_PATH=$CHEFDK_GECODE_PATH/include
          - LUALIB=~/.luarocks/lib/lua/5.2
          # - EXPEDITOR=true
          - USE_OMNIBUS_FILES=0
          - PEDANT_OPTS="--skip-oc_id"
          - CHEF_FS=1
          - BUNDLE_GEMFILE=/workdir/oc-chef-pedant/Gemfile
