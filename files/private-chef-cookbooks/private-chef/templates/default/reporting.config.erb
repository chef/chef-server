%% -*- mode: erlang -*-
[
 {kernel, [{start_pg2, true}]},
 %% SASL config
 {sasl, [
         {sasl_error_logger, {file, "<%= File.join(@log_directory, 'sasl-error.log') %>"}},
         {errlog_type, error},
         {error_logger_mf_dir, "<%= File.join(@log_directory, 'sasl') %>"},      % Log directory
         {error_logger_mf_maxbytes, 104857600},   % 10 MB max file size
         {error_logger_mf_maxfiles, 5}           % 5 files max
        ]},
{fast_log, [
             {loggers, [[{name, reporting},
                         {file, "<%= File.join(@log_directory, 'reporting.log') %>"},
                         {files, 5},
                         {file_size, 50}]]}
            ]},
  {chef_db, [
           {cache_defaults, [{max_size, <%= @max_cache_size %> },
                               {ttl, <%= @cache_ttl %> }]},
           {couchdb_host, "<%= node['private_chef']['couchdb']['vip'] %>"},
           {couchdb_port, <%= node['private_chef']['couchdb']['port'] %> }
          ]},
  {chef_authn, [
                {keyring, [{default, "/etc/opscode/webui_pub.pem"}]}
               ]},
  {chef_authz, [
                {authz_root_url, "http://<%= node['private_chef']['opscode-authz']['vip'] %>:<%= node['private_chef']['opscode-authz']['port'] %>" },
                {couchdb_host, "<%= node['private_chef']['couchdb']['vip'] %>"},
                {couchdb_port, <%= node['private_chef']['couchdb']['port'] %> }
               ]},
  {chef_index, [
                {solr_url, "http://<%= node['private_chef']['opscode-solr']['vip'] %>:<%= node['private_chef']['opscode-solr']['port'] %>/solr"}
               ]},
 {reporting, [{server_name, "<%= @server_name %>" },
          {ip, "<%= @listen %>" },
          {port, <%= @port %> },

          {log_dir, "<%= @log_directory %>"},
          {node_search_limit, "<%= @node_search_limit %>" },
          {metrics_module, folsom_metrics}
          ]},

{stats_hero, [
               {udp_socket_pool_size, 1 },
               {estatsd_host, "127.0.0.1" },
               {estatsd_port, 5665 },
               {my_app, "reportingAPI"},
               {upstream_prefixes, [<<"rdbms">>, <<"couch">>, <<"authz">>, <<"solr">>, <<"reporting_db">>]},
               {label_fun, {reporting_app, label_mfa}}
              ]},
              
{sqerl, [
           %% The database system you are using (e.g., mysql, pgsql)
           {db_type, <%= node['private_chef']['database_type'] == "postgresql" ? "pgsql" : "mysql" %> },

           %% Database connection parameters
           {db_host, "<%= node['private_chef'][node['private_chef']['database_type']]['vip'] %>"},
           {db_port, <%= node['private_chef']['database_type'] == "postgresql" ? 5432 : 3306 %>},
           {db_user, "<%= node['private_chef'][node['private_chef']['database_type']]['sql_user'] %>"},
           {db_pass, "<%= node['private_chef'][node['private_chef']['database_type']]['sql_password'] %>"},
           {db_name, "opscode_chef" },

           {prepared_statements, {reporting_sql, statements, [<%= node['private_chef']['database_type'] == "postgresql" ? "pgsql" : "mysql" %>]}},
           {column_transforms, undefined}
           ]},
  {pooler, [
           {pools, [[{name, "sqerl"},
                     {max_count, <%= node['private_chef']['opscode-reporting']['db_pool_max_count'] %> },
                     {init_count, <%= node['private_chef']['opscode-reporting']['db_pool_init_count'] %> },
                     {start_mfa, {sqerl_client, start_link, []}}]]}
          ]}
].

