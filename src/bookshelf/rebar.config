%% -*- mode: erlang -*-
%% -*- tab-width: 4;erlang-indent-level: 4;indent-tabs-mode: nil -*-
%% ex: ts=4 sw=4 ft=erlang et



{erl_dep_retries, 10}.




{require_otp_vsn, "18.*|19.*"}.

{deps, [
    %% lager has to come first since we use its parse transform
    {lager, ".*",
        {git, "https://github.com/basho/lager.git",                     {tag, "2.1.1"}}},
%   {bcrypt, ".*",
%       {git, "https://github.com/smarkets/erlang-bcrypt.git",          {branch, "master"}}},
    {cf, "",
        {git, "https://github.com/project-fifo/cf.git",                 {branch, "master"}}},
%   {chef_authn, ".*",
%       {git, "https://github.com/chef/chef_authn.git",                 {branch, "master"}}},
%   {chef_reindex, ".*",
%       {git, "https://github.com/opscode/chef_reindex.git",            {branch, "master"}}},
    {chef_secrets, ".*",
        {git, "https://github.com/chef/chef_secrets.git",               {branch, "master"}}},

%   {darklaunch, ".*",
%       {git, "https://github.com/chef/opscode-darklaunch-erlang.git",  {branch, "master"}}},
%   {edown, ".*",
%       {git, "https://github.com/uwiger/edown.git",                    {branch, "master"}}},
%   {efast_xs, ".*",
%       {git, "https://github.com/chef/efast_xs.git",                   {branch, "master"}}},
    {ej, ".*",
        {git, "https://github.com/seth/ej.git", {                       branch, "master"}}},
    {envy, ".*",
        {git, "https://github.com/markan/envy.git",                     {branch, "master"}}},
    {eper, ".*",
        {git, "https://github.com/massemanet/eper.git",                 {branch, "master"}}},
%   {epgsql,".*",
%       {git, "https://github.com/chef/epgsql-1.git",                   {branch, "master"}}},
    {eredis, ".*",
        {git, "https://github.com/wooga/eredis.git",                    {tag, "master"}}},
    {erlsom, ".*",
        {git, "https://github.com/chef/erlsom.git",                     {branch, "integer_long_string_probs"}}},
    {erlware_commons, ".*",
        {git, "https://github.com/chef/erlware_commons.git",            {branch, "ma/fix_for_ftmap"}}},    
%   {folsom, ".*",
%       {git, "https://github.com/boundary/folsom.git",                 {tag, "0.8.2"}}},
%   {folsom_graphite, ".*",
%       {git, "https://github.com/chef/folsom_graphite.git",            {branch, "master"}}},
%   {gen_bunny, ".*",
%       {git, "https://github.com/seth/gen_bunny.git",                  {branch, "master"}}},
%   {ibrowse, ".*",
%       {git, "https://github.com/cmullaparthi/ibrowse.git",            {branch, "master"}}},
    {iso8601, ".*",
         {git, "https://github.com/erlsci/iso8601.git",                 {tag, "1.2.3"}}},
    {jiffy, ".*",
        {git, "https://github.com/davisp/jiffy.git",                    {branch, "master"}}},
    {meck, ".*",
         {git, "https://github.com/eproxus/meck.git",                   {tag, "0.8.4"}}},    
    {mini_s3, ".*",
        {git, "https://github.com/chef/mini_s3.git",                    {branch, "master"}}},
    {mixer, ".*",
        {git, "https://github.com/chef/mixer.git",                      {tag, "0.1.1"}}},    
    {mochiweb, ".*",
        {git, "https://github.com/mochi/mochiweb.git",                  {tag, "v2.12.2"}}},
%   {moser, ".*",
%       {git, "https://github.com/opscode/moser.git",                   {branch, "master"}}},
%   {neotoma, "", %% <---- ?
%       {git, "https://github.com/seancribbs/neotoma.git",              {tag, "1.7.2"}}},
    {observer_cli, ".*",
        {git, "https://github.com/zhongwencool/observer_cli.git",       {branch, "master"}}},
%   {opscoderl_folsom, ".*",
%       {git, "https://github.com/chef/opscoderl_folsom.git",           {branch, "master"}}},
%   {opscoderl_httpc, ".*",
%       {git, "https://github.com/chef/opscoderl_httpc.git",            {branch, "master"}}},
    {opscoderl_wm, ".*",
        {git, "https://github.com/chef/opscoderl_wm.git",               {branch, "master"}}},
%   {pooler, ".*",
%       {git, "https://github.com/seth/pooler.git",                     {branch, "master"}}},
%   {prometheus, ".*",
%       {git, "https://github.com/deadtrickster/prometheus.erl.git",    {tag, "v3.4.0"}}},
    {sqerl, ".*",
        {git, "https://github.com/chef/sqerl.git",                      {branch, "master"}}},
%   {stats_hero, ".*", %% ANOMALY
%       {git, "https://github.com/chef/stats_hero.git",                 {branch, "master"}}},
    {sync, ".*",
        {git, "https://github.com/rustyio/sync.git",                    {branch, "master"}}}
%   {uuid, ".*",
%       {git, "https://github.com/okeuday/uuid.git",                    {tag, "v1.6.0"}}}







        % These are indirect dependencies via chef_secrets, but we want to override them locally
    ]}.


{erl_opts, [
    debug_info,
    {parse_transform, lager_transform},
    warnings_as_errors,
    {i, "include"}
]}.

{eunit_compile_opts, [{d,'EUNIT_TEST'}]}.

{plugins, [ {pc, "1.8.0"} ]}. % Locked to avoid fallout related to: https://github.com/blt/port_compiler/issues/43

{xref_checks,
 [undefined_function_calls,
  undefined_functions,
  locals_not_used,
  deprecated_function_calls,
  deprecated_functions]}.

{xref_queries,
 [ %% Use this instead of `exports_not_used`; we'll filter out references to
   %% generic callbacks, generated functions, etc.
   %%
   %% Ideally, we want no functions to come back from this query; that means
   %% we're using everything! Adjust regexes / remove code until this is the
   %% case.
   {"UU" %% Unused functions (xref builtin)
   " - "
   "\"bksw_app\":\"(start|stop)\"/\".*\"" %% application callbacks
   " - "
   "\"bksw_app\":\"remsh_welcome\"/\".*\"" %% application callbacks
   " - "
   "\".*_sup\":\"init\"/\"1\"" %% supervisor callbacks
   " - "
   "\".*\":\"start_link\"/\".*\"" %% any start_link fun
   " - "
   "\"bksw_cleanup_task\":\"(init|handle_call|handle_cast|handle_info|terminate|code_change)\"/\".*\"" %% gen_server generic callback funs
   " - "
   "\"bksw_cleanup_task\":\"(force_deleted_cleanup|force_upload_cleanup)\"/\".*\"" %% intended to be used from a remsh
   " - "
   "\".*_wm_.*\":\"(init|ping|is_authorized|finish_request|service_available|to_xml|resource_exists|allowed_methods|content_types_accepted|content_types_provided|generate_etag|last_modified|delete_resource)\"/\".*\"" %% (some) Webmachine callbacks
   " - "
   "\"(bksw_wm_sql_bucket|bksw_wm_bucket)\":\"(create_resource)\"/\".*\"" %% content_types_accepted-defined callbacks,
   " - "
   "\"(bksw_sql|bksw_sql)\":\"(ping|statements)\"/\".*\""
   " - "
   "\"(bksw_xml)\":\"(write_erl|write_hrl)\"/\".*\"" %% these look like they might be mean to run manually?
   " - "
   "\"(bksw_conf)\":\"(reset_dispatch)\"/\".*\"" %% used in tests
   " - "
   "\"(bksw_wm_sql_object|bksw_wm_object)\":\"(validate_content_checksum|upload|download)\"/\".*\"" %% content_types_accepted-defined callbacks,
  ,[]} %% Expected results (i.e., nothing)
 ]}.

{cover_enabled, true}.

{pre_hooks, [
             {clean, "make version_clean"},
             {compile, "make VERSION"}
]}.

{profiles, [
    {dev, [
        {relx, [{dev_mode, true},
                {include_src, true}
               ]}
       ]},
    {test, [
        {deps, [
            cth_readable
        ]}
    ]}
]}.

{ct_opts, [
    {dir, "test"},
    {ct_hooks, [cth_readable_failonly, cth_readable_shell]}
]}.

{relx, [
  {release,{bookshelf,{cmd,"cat VERSION"}},
    [bookshelf,
     chef_secrets,
     {sync, load},
     {eunit, load},
     {mixer, load},
     syntax_tools,
     compiler,
     eper,
     observer_cli,
     {pooler, load},
     {sqerl, load}
  ]},

  {include_erts, false},
  {include_src, false},
  {extended_start_script,true},
  {overlay,[{template,"config/app.config","sys.config"},
            {copy,"schema","."}
           ]}
]}.
