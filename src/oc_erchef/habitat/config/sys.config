%% -*- mode: erlang -*-
%% -*- tab-width: 4;erlang-indent-level: 4;indent-tabs-mode: nil -*-
%% ex: ts=4 sw=4 ft=eruby.erlang et
[
    {kernel, [{inet_dist_use_interface, {127,0,0,1}}]},
    {lager, [
          %% What handlers to install with what arguments
          %% The defaults for the logfiles are to rotate the files when
          %% they reach 10Mb or at midnight, whichever comes first, and keep
          %% the last 5 rotations. See the lager README for a description of
          %% the time rotation format:
          %% https://github.com/basho/lager/blob/master/README.org
          %%
          %% If you wish to disable rotation, you can either set the size to 0
          %% and the rotation time to "", or instead specify a 2-tuple that only
          %% consists of {Logfile, Level}.
          {handlers, [
                      {lager_console_backend, {{cfg.lager.lager_console_backend}}},
                      {lager_file_backend, [{file, "{{pkg.svc_var_path}}/log/error.log"},
                                            {level, error}, {size, 10485760},
                                            {date, "$D0"}, {count, 5}]},
                      {lager_file_backend, [{file, "{{pkg.svc_var_path}}/log/console.log"},
                                            {level, info}, {size, 10485760},
                                            {date, "$D0"}, {count, 5}]}
                     ]},

          %% Whether to write a crash log, and where.
          %% Commented/omitted/undefined means no crash logger.
          {crash_log, "{{pkg.svc_var_path}}/log/crash.log"},

          %% Maximum size in bytes of events in the crash log - defaults to 65536
          {crash_log_msg_size, 65536},

          %% Maximum size of the crash log in bytes, before its rotated, set
          %% to 0 to disable rotation - default is 0
          {crash_log_size, 10485760},

          %% What time to rotate the crash log - default is no time
          %% rotation. See the lager README for a description of this format:
          %% https://github.com/basho/lager/blob/master/README.org
          {crash_log_date, "$D0"},

          %% Number of rotated crash logs to keep, 0 means keep only the
          %% current one - default is 0
          {crash_log_count, 5},

          %% Whether to redirect error_logger messages into lager - defaults to true
          {error_logger_redirect, true}

        %% Bump up the "high-water mark" (default 50), which is the
        %% number of messages per second allowed to come from
        %% error_logger.  This is the same as used by
        %% opscode-chef-mover, FWIW.
        {error_logger_hwm, cfg.lager.error_logger_hwm}
    ]},

    {chef_secrets, [
        {provider, chef_secrets_json_file},
        %% TODO: don't hard code this path
        {provider_config, [{secrets_file, "{{pkg.svc_config_path}}/private-chef-secrets.json"}]}
    ]},

    {oc_chef_wm, [
        {ip_mode, [ {{cfg.private_chef.ip_mode}} ] },
        {api_version, "{{cfg.oc_chef_wm.api_version}}"},
        {server_flavor, "{{cfg.oc_chef_wm.flavor}}"},

        {default_orgname, {{cfg.oc_chef_wm.default_orgname}} },

        {ip, "{{cfg.oc_chef_wm.listen_ip}}"},
        {port, {{cfg.oc_chef_wm.port}}},
        {reqid_header_name, "X-Request-Id"},
        {auth_skew, {{cfg.oc_chef_wm.auth_skew}}},
        %% currently only used by the search endpoint to bound
        %% how many nodes are deserialized at a time in
        %% preparing a response.
        {bulk_fetch_batch_size, {{cfg.oc_chef_wm.bulk_fetch_batch_size}}},
        {superusers, [<<"pivotal">>]},
        %% metrics config
        {root_metric_key, "{{cfg.oc_chef_wm.root_metric_key}}"},

        {authz_timeout, {{cfg.oc_chef_wm.authz_timeout}}},
        {authz_fanout, {{cfg.oc_chef_wm.authz_fanout}}},

        {reindex_batch_size, {{cfg.oc_chef_wm.reindex_batch_size}}},

        {enable_actions, {{cfg.oc_chef_wm.actions}}},
        %% Ignore ldap in the habitat config for now
        {ldap, []},
        %% these are used for reporting on license status on the
        %% license endpoint; it would have been nice to give these
        %% their own logical section, but erlang requires these to
        %% be part of a loaded application
        {node_license, {{cfg.oc_chef_wm.node_license}}},
        {upgrade_url, <<"{{cfg.oc_chef_wm.upgrade_url}}">>},
        {actions_host, "{{cfg.oc_chef_wm.actions_host}}"},
        {actions_port, {{cfg.oc_chef_wm.ctions_port}} },
        {actions_user, <<"{{cfg.oc_chef_wm.actions_user}}">>},
        {actions_vhost, <<"{{cfg.oc_chef_wm.actions_vhost}}">>},
        {actions_exchange, <<"{{cfg.oc_chef_wm.actions_exchange}}">>},
        {actions_fqdn, <<"{{cfg.oc_chef_wm.actions_fqdn}}">>},
        {max_request_size, {{cfg.oc_chef_wm.max_request_size}} %>},
        {server_version, "{{cfg.oc_chef_wm.server_version}}"},
        {health_ping_timeout, {{cfg.oc_chef_wm.health_ping_timeout}}},
        {health_ping_modules, [
            {{#if cfg.data_collector.enabled}}
            data_collector,
            {{/if}}
            oc_chef_authz,
            chef_sql,
            chef_{{cfg.oc_chef_wm.search_provider}}
        ]},
        {base_resource_url, {{cfg.oc_chef_wm.base_resource_url}} },
        {bulk_fetch_batch_size, {{cfg.oc_chef_wm.bulk_fetch_batch_size}} },
        {strict_search_result_acls, {{cfg.oc_chef_wm.strict_search_result_acls}} },

        {rabbitmq, [
            {management,[
                {user, "{{cfg.oc_chef_wm.rabbitmq.management.user}}"},
                {port, {{cfg.oc_chef_wm.rabbitmq.management.port}} },
                % rabbitmq management http connection pool
                {rabbitmq_management_service, [
                    {{#if cfg.private_chef.fips_enabled ~}}
                    %% See note about Bookshelf
                    {root_url, "http://{{cfg.oc_chef_wm.actions_host}}:{{cfg.oc_chef_wm.rabbitmq.management.port}}/api"},
                    {{else ~}}
                    {root_url, "https://{{cfg.oc_chef_wm.actions_host}}:{{cfg.oc_chef_wm.rabbitmq.management.port}}/api"},
                    {{/if ~}}
                    {timeout, {{cfg.oc_chef_wm.rabbitmq.management.timeout']}} },
                    {init_count, {{cfg.oc_chef_wm.rabbitmq.management.init_count}} },
                    {max_count, {{cfg.oc_chef_wm.rabbitmq.management.max_count}} },
                    {cull_interval, {{{cfg.oc_chef_wm.rabbitmq.management.cull_interval}}, sec}},
                    {max_age, {{{cfg.oc_chef_wm.rabbitmq.management.max_age}}, sec}},
                    {max_connection_duration, {{{cfg.oc_chef_wm.rabbitmq.management.max_connection_duration}}, sec}},

                    {ibrowse_options, [
                        {{cfg.oc_chef_wm.rabbitmq.management.ibrowse_options}}
                    ]}
                ]}
            ]},
            {{#if cfg.oc_chef_wm.rabbitmq.monitoring.queue_length_monitor_enabled ~}}
            {{#if cfg.oc_chef_wm.enable_actions ~}}
            {monitoring, [
                {queue_length_monitor_enabled, true},
                {queue_length_monitor_vhost, "{{cfg.oc_chef_wm.rabbitmq.monitoring.queue_length_monitor_vhost}}"},
                {queue_length_monitor_queue, "{{cfg.oc_chef_wm.rabbitmq.monitoring.queue_length_monitor_queue}}"},
                {queue_length_monitor_millis, {{cfg.oc_chef_wm.rabbitmq.monitoring.queue_length_monitor_millis}} },
                {queue_length_monitor_timeout_millis, {{cfg.oc_chef_wm.rabbitmq.monitoring.queue_length_monitor_timeout_millis}} },
                {drop_on_full_capacity, {{cfg.oc_chef_wm.rabbitmq.monitoring.drop_on_full_capacity}} },
                {prevent_erchef_startup_on_full_capacity, {{cfg.oc_chef_wm.rabbitmq.monitoring.prevent_erchef_startup_on_full_capacity}} },
                {queue_at_capacity_affects_overall_status, {{cfg.oc_chef_wm.rabbitmq.monitoring.queue_at_capacity_affects_overall_status}} }
            ]}
            {{/if ~}}
            {{/if ~}}
        ]}
    ]},

    {chef_authn, [
        {keyring, [{default, "{{pkg.svc_var_path}}/webui_pub.pem"}]},
        {{ unless {{cfg.chef_authn.keygen_cache_workers_enabled ~}}
        {keygen_cache_workers, {{cfg.chef_authn.keygen_cache_workers}} },
        {{/unless ~}}
        {keygen_cache_size, {{cfg.chef_authn.keygen_cache_size}} },
        {keygen_start_size, {{cfg.chef_authn.keygen_start_size}} },
        {keygen_timeout, {{cfg.chef_authn.keygen_timeout}} },
        {keygen_size, {{cfg.chef_authn.keygen_key_size}} }
    ]},

    {oc_chef_authz, [
        {authz_root_url, "http://<%= @helper.vip_for_uri('oc_bifrost') %>:<%= node['private_chef']['oc_bifrost']['port'] %>" },
        {authz_service, [
            {root_url, "http://<%= @helper.vip_for_uri('oc_bifrost') %>:<%= node['private_chef']['oc_bifrost']['port'] %>" },
            {timeout, <%= node['private_chef']['opscode-erchef']['authz_timeout'] %>},
            {init_count, <%= node['private_chef']['oc_chef_authz']['http_init_count'] %>},
            {max_count, <%= node['private_chef']['oc_chef_authz']['http_max_count'] %>},
            {queue_max, <%= node['private_chef']['oc_chef_authz']['http_queue_max'] %>},
            {cull_interval, <%= node['private_chef']['oc_chef_authz']['http_cull_interval'] %>},
            {max_age, <%= node['private_chef']['oc_chef_authz']['http_max_age'] %>},
            {max_connection_duration, <%= node['private_chef']['oc_chef_authz']['http_max_connection_duration'] %>},
            {ibrowse_options, <%= node['private_chef']['oc_chef_authz']['ibrowse_options'] %>}
        ]},
        {cleanup_batch_size, <%= node['private_chef']['opscode-erchef']['cleanup_batch_size'] %>}
    ]},

    {chef_db, [
        {bulk_fetch_batch_size, <%= @bulk_fetch_batch_size %>}
    ]},

    {chef_index, [
        {ip_mode, [ <%=PrivateChef['use_ipv6'] ? "ipv6,ipv4" : "ipv4" %> ] },
        {rabbitmq_host, "<%= node['private_chef']['rabbitmq']['vip'] %>"},
        {rabbitmq_port, <%= node['private_chef']['rabbitmq']['node_port'] %> },
        {rabbitmq_user, <<"<%= node['private_chef']['rabbitmq']['user'] %>">>},
        {rabbitmq_vhost, <<"<%= node['private_chef']['rabbitmq']['vhost'] %>">>},
        {rabbitmq_exchange, <<"">>},
        {search_provider, <%= node['private_chef']['opscode-erchef']['search_provider'] %>},
        {search_queue_mode, <%= node['private_chef']['opscode-erchef']['search_queue_mode'] %>},
        {search_batch_max_size, <%= node['private_chef']['opscode-erchef']['search_batch_max_size'] %>},
        {search_batch_max_wait, <%= node['private_chef']['opscode-erchef']['search_batch_max_wait'] %>},
        {reindex_sleep_min_ms, <%= @reindex_sleep_min_ms -%>},
        {reindex_sleep_max_ms, <%= @reindex_sleep_max_ms -%>},
        {reindex_item_retries, <%= @reindex_item_retries -%>},
        {solr_service, [
            {root_url, "<%= @helper.solr_url() %>"},
            {timeout, <%= @solr_timeout %>},
            {init_count, <%= @solr_http_init_count %>},
            {max_count, <%= @solr_http_max_count %>},
            {cull_interval, <%= @solr_http_cull_interval %>},
            {max_age, <%= @solr_http_max_age %>},
            {max_connection_duration, <%= @solr_http_max_connection_duration %>},
            {ibrowse_options, <%= @solr_ibrowse_options %>}
        ]}
    ]},

    {chef_objects, [
        <% if node['private_chef']['fips_enabled'] -%>
        %% When we're using a fips openssl, we default to using http for bookshelf.
        %% The reason for this is because we do not have a TLS implementation for
        %% Erlang when we turn on fips.
        %%
        %% This is the reason that the only supported configuration for the fips
        %% package is standalone. We will allow http over localhost so that the
        %% chef server can talk to bookshelf.
        {s3_url, "http://<%= node['private_chef']['bookshelf']['listen'] %>:<%= node['private_chef']['bookshelf']['port'] %>"},
        <% else -%>
        {s3_url, "<%= @helper.bookshelf_s3_url %>"},
        <% end %>
        {s3_external_url, <%= @helper.erl_atom_or_string(node['private_chef']['bookshelf']['external_url']) %>},
        {s3_platform_bucket_name, "<%= node['private_chef']['opscode-erchef']['s3_bucket'] %>"},
        {s3_url_ttl, <%= node['private_chef']['opscode-erchef']['s3_url_ttl'] %>},
        {s3_url_expiry_window_size, <%= @helper.s3_url_caching(node['private_chef']['opscode-erchef']['s3_url_expiry_window_size']) %>},
        {s3_parallel_ops_timeout, <%= node['private_chef']['opscode-erchef']['s3_parallel_ops_timeout'] %>},
        {s3_parallel_ops_fanout, <%= node['private_chef']['opscode-erchef']['s3_parallel_ops_fanout'] %>},
        {depsolver_timeout, <%= @depsolver_timeout %>},
        {depsolver_pooler_timeout, <%= @depsolver_pooler_timeout %>}
    ]},

    <% if node['private_chef']['data_collector']['root_url'] %>
    {data_collector, [
        {root_url,                "<%= node['private_chef']['data_collector']['root_url'] %>"},
        {token,                   "<%= node['private_chef']['data_collector']['token'] %>"},
        {timeout,                 <%= node['private_chef']['data_collector']['timeout'] %>},
        {init_count,              <%= node['private_chef']['data_collector']['http_init_count'] %>},
        {max_count,               <%= node['private_chef']['data_collector']['http_max_count'] %>},
        {cull_interval,           <%= node['private_chef']['data_collector']['http_cull_interval'] %>},
        {max_age,                 <%= node['private_chef']['data_collector']['http_max_age'] %>},
        {max_connection_duration, <%= node['private_chef']['data_collector']['http_max_connection_duration'] %>},
        {ibrowse_options,         <%= node['private_chef']['data_collector']['ibrowse_options'] %>}
    ]},
    <% end %>

    {stats_hero, [
        {udp_socket_pool_size, <%= @udp_socket_pool_size || @db_pool_size %> },
        {protocol, <%= node['private_chef']['estatsd']['protocol'] %>},
        {estatsd_host, "<%= @helper.normalize_host(node['private_chef']['estatsd']['vip']) %>"},
        {estatsd_port, <%= node['private_chef']['estatsd']['port'] %>}
    ]},

    {opscoderl_httpc, [
        {pooler_timeout, <%= @authz_pooler_timeout %>}
    ]},

    {sqerl, [
        {db_driver_mod, sqerl_pgsql_client},
        {config_cb, {chef_secrets_sqerl, config, [{<<"opscode_erchef">>, <<"sql_password">>}]}},
        {ip_mode, [ <%=PrivateChef['use_ipv6'] ? "ipv6,ipv4" : "ipv4" %> ] },
        %% Database connection parameters
        {db_host, "<%= node['private_chef']['postgresql']['vip'] %>"},
        {db_port, <%= node['private_chef']['postgresql']['port'] %>},
        %% TODO(ssd): Should this move into chef_secrets as well
        {db_user, "<%= node['private_chef']['opscode-erchef']['sql_user'] %>"},
        {db_name, "opscode_chef" },
        {idle_check, 10000},
        {pooler_timeout, <%= @db_pooler_timeout %>},
        {db_timeout, <%= node['private_chef']['opscode-erchef']['sql_db_timeout'] %>},
        {prepared_statements, {oc_chef_sql, statements, [pgsql]}},
        {column_transforms, [
            {<<"created_at">>, {sqerl_transformers, convert_YMDHMS_tuple_to_datetime}},
            {<<"updated_at">>, {sqerl_transformers, convert_YMDHMS_tuple_to_datetime}}
        ]}
    ]},

    {webmachine, [
        {log_handlers, [
            {oc_wm_request_logger, [
                {file, "<%= File.join(@log_directory, 'requests.log') %>"},
                {file_size, <%= (@log_rotation['file_maxbytes'].to_f/1024/1024).round %>},  %% Size in MB
                {files, <%= @log_rotation['num_to_keep'] %>},
                {annotations, [req_id, org_name, msg, darklaunch, perf_stats, user, req_api_version]}
            ]}
        ]}
    ]},

    {ibrowse, [
        {default_max_sessions, <%= @ibrowse_max_sessions %>},
        {default_max_pipeline_size, <%= @ibrowse_max_pipeline_size %>}
    ]},

    {pooler, [
        {pools, [
            [
                {name, sqerl},
                {max_count, <%= @db_pool_max || @db_pool_size %>},
                {init_count, <%= @db_pool_init || @db_pool_size %>},
                {start_mfa, {sqerl_client, start_link, []}},
                {queue_max, <%= @db_pool_queue_max %>}
            ],
            [
                {name, chef_depsolver},
                {max_count, <%= @depsolver_worker_count %>},
                {init_count, <%= @depsolver_worker_count %>},
                {queue_max, <%= @depsolver_pool_queue_max %>},
                {start_mfa, {chef_depsolver_worker, start_link, []}}
            ]
        ]
    },

    {metrics_module, folsom_metrics}
]}
].
