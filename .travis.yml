language: erlang
sudo: false
branches:
  only:
  - master
  - mp/custom-cache
cache:
  apt: true
  directories:
    # TODO - I think we need this to get the before cache hook
    # but test and remove if not
  - ".fakecache"
env:
  matrix:
    #- COMPONENT=omnibus
  - COMPONENT=src/oc_erchef
    #- COMPONENT=src/oc-id
    # - COMPONENT=src/chef-mover

matrix:
- fast_finish: true

before_install:
  - "$TRAVIS_BUILD_DIR/scripts/fetch-and-extract-cache.sh $COMPONENT"

before_cache:
  - "$TRAVIS_BUILD_DIR/scripts/update-cache.sh $COMPONENT"

otp_release:
- 17.4

addons:
  postgresql: '9.3'
  apt:
    packages:
    - cpanminus
    - perl
    - lua5.1
    - luarocks
    - libdbd-pg-perl
    - build-essential

install:
   - export PERL5LIB=~/perl5/lib/perl5/x86_64-linux-gnu-thread-multi:~/perl5/lib/perl5:/etc/perl:/usr/local/lib/perl/5.14.2:/usr/local/share/perl/5.14.2:/usr/lib/perl5:/usr/share/perl5:/usr/lib/perl/5.14:/usr/share/perl/5.14:/usr/local/lib/site_perl
   - eval $(perl -I ~/perl5/lib/perl5/ -Mlocal::lib)
  - cd $COMPONENT && travis_retry make install

script:
- $TRAVIS_BUILD_DIR/scripts/build.sh $COMPONENT"
