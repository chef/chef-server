language: erlang
sudo: false
branches:
  only:
  - master

cache:
  apt: true

env:
  matrix:
  - COMPONENT=src/oc_erchef
  - COMPONENT=src/oc-id
  - COMPONENT=omnibus
  - COMPONENT=src/chef-mover
  global:
  - secure: P+umMQ2vQVn/Stsa3akrA5Dqikvl15lO3A+NRihEv0KiOXHR28QkZXl/WxXXPLwwZGWfJWMsh5sAhPgVh265lq8sc75aFW9y6a1eHOQ7dXCwGqp/I+bl2sDMVEtpN3RdnjG71bQ2eE0ouIXndNb+l5+QoEdyzch1FGPE7oGGLPo=
  - secure: MDM7goIUhoSiR36yCML+Dcl0Qr7ZZUVEs/jLlrgCHRScvz3NTYhUVsp3gEHEmhmdOikB6Fzc0SyDoFxfL3BCpN/vAPZmFlZcXPuJAswdBBw+3qJirl6+FVg5X2Qp5GAXv8AwLzn5CWn5hVvQzCXwVC68aBapyfIFnUVE9NHGKm4=

matrix:
  - fast_finish: true

before_install:
  - $TRAVIS_BUILD_DIR/scripts/fetch-and-extract-cache.sh $COMPONENT

before_cache:
  - $TRAVIS_BUILD_DIR/scripts/update-cache.sh $COMPONENT

otp_release:
  - 17.4

addons:
  postgresql: '9.3'
  apt:
    packages:
    - cpanminus
    - perl
    - lua5.1
    - luarocks
    - libdbd-pg-perl
    - build-essential

install:
  - export PERL5LIB=~/perl5/lib/perl5/x86_64-linux-gnu-thread-multi:~/perl5/lib/perl5:/etc/perl:/usr/local/lib/perl/5.14.2:/usr/local/share/perl/5.14.2:/usr/lib/perl5:/usr/share/perl5:/usr/lib/perl/5.14:/usr/share/perl/5.14:/usr/local/lib/site_perl
  - eval $(perl -I ~/perl5/lib/perl5/ -Mlocal::lib)
  - cd $COMPONENT && travis_retry make install

script:
  - $TRAVIS_BUILD_DIR/scripts/build.sh $COMPONENT
